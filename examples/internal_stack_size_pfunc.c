#include <stdio.h>
#include <xcore/parallel.h>

typedef struct {
  const unsigned * const ints;
  const size_t number;
  unsigned long result;
} thread_sum_args_t;

void thread_sum(thread_sum_args_t * args)
{
  unsigned long sum = 0;
  printf("Summing %u unsigneds starting at %p\n", args->number, args->ints);
  for (size_t count = 0; count < args->number; count += 1) {
    sum += args->ints[count];
  }
  args->result = sum;
}

static const unsigned ints1[] = {1, 34, 13, 240, 229, 153, 33, 169, 90, 40, 20, 29, 49, 104, 141, 194, 245, 41, 120, 165, 222, 92, 44, 87, 224, 101, 62, 32, 67, 114, 130, 188, 217, 58, 97, 124, 53, 138, 67, 196, 249, 106, 207, 104, 42, 61, 199, 246, 125, 176, 116, 199, 167, 127, 129, 220, 237, 119, 123, 205, 26, 27, 141, 136, 116, 103, 91, 187, 125, 181, 171, 11, 90, 124, 110, 140, 135, 172, 128, 154, 214, 244, 52, 184, 20, 88, 147, 10, 101, 147, 50, 66, 84, 2, 251, 108, 204, 46, 102, 16, 5, 85, 58, 218, 70, 184, 85, 144, 163, 230, 242, 148, 219, 56, 38, 46, 81, 217, 85, 86, 211, 215, 205, 85, 62, 192, 118, 191, 195, 220, 121, 130, 79, 188, 247, 246, 198, 177, 217, 75, 109, 90, 126, 70, 56, 183, 210, 202, 213, 176, 252, 75, 32, 248, 207, 131, 101, 115, 101, 30, 10, 203, 101, 157, 212, 65, 163, 25, 151, 32, 57, 33, 87, 207, 74, 106, 40, 183, 6, 182, 58, 236, 63, 216, 52, 109, 43, 175, 58, 20, 226, 192, 31, 78, 133, 59, 1, 88, 230, 6, 96, 170, 43, 191, 101, 233, 13, 85, 97, 133, 181, 254, 85, 200, 44, 74, 111, 85, 231, 131, 6, 56, 127, 149, 53, 90, 184, 245, 131, 149, 3, 82, 101, 117, 190, 114, 90, 92, 248, 52, 136, 27, 48, 211, 6, 158, 80, 113, 131, 189, 186, 224, 28, 69, 201, 70, 40, 246, 45, 198, 133, 136, 82, 186, 166, 240, 85, 108, 47, 198, 158, 132, 178, 219, 78, 172, 235, 78, 173, 118, 157, 14, 72, 28, 138, 238, 120, 47, 28, 180, 208, 33, 126, 23, 183, 46, 127, 24, 162, 183, 247, 196, 213, 165, 187, 38, 81, 95, 34, 9, 160, 201, 246, 75, 86, 138, 82, 215, 230, 17, 5, 194, 21, 246, 210, 0, 121, 154, 53, 230, 167, 250, 158, 66, 251, 120, 209, 160, 25, 131, 245, 218, 38, 82, 30, 1, 8, 192, 103, 25, 22, 176, 25, 85, 31, 161, 182, 176, 238, 122, 238, 30, 191, 105, 190, 111, 194, 86, 66, 77, 34, 185, 145, 159, 25, 169, 89, 173, 149, 245, 217, 100, 186, 180, 172, 152, 255, 171, 30, 106, 239, 198, 60, 99, 134, 230, 173, 27, 16, 252, 24, 172, 112, 47, 136, 142, 170, 91, 232, 21, 79, 206, 31, 58, 26, 52, 151, 84, 81, 160, 37, 226, 201, 196, 135, 5, 172, 146, 119, 168, 225, 211, 211, 75, 96, 95, 192, 227, 26, 253, 245, 193, 243, 207, 16, 45, 112, 190, 181, 103, 182, 21, 249, 89, 164, 205, 115, 53, 39, 151, 39, 207, 236, 102, 178, 113, 174, 253, 221, 99, 253, 212, 67, 86, 174, 154, 0, 86, 163, 243, 74, 3, 13, 224, 1, 55, 200, 161, 177, 121, 129, 36, 145, 180, 209, 98, 55, 108, 73, 152, 112, 104, 154, 95, 31, 162, 91, 21, 54, 65, 35, 230, 74, 109, 228, 84, 232, 26, 118, 204, 30, 53, 57, 16, 34, 1, 24, 188, 93, 182, 24, 44, 88, 159, 124, 101, 145, 156, 235, 13, 24, 177, 107, 54, 0, 236, 238, 24, 84, 216, 72, 22, 103, 28, 72, 148, 242, 100, 18, 211, 200, 50, 129, 236, 25, 199, 18, 165, 209, 163, 23, 119, 93, 171, 207, 236, 138, 42, 180, 31, 137, 17, 184, 207, 28, 161, 168, 41, 8, 162, 26, 50, 84, 56, 149, 13, 195, 180, 200, 125, 23, 218, 227, 215, 190, 238, 176, 121, 210, 231, 251, 103, 104, 195, 100, 47, 194, 77, 235, 51, 193, 250, 78, 20, 29, 146, 229, 216, 166, 0, 87, 194, 199, 160, 71, 88, 93, 174, 64, 84, 98, 131, 219, 106, 237, 226, 225, 160, 30, 53, 242, 88, 20, 109, 48, 142, 142, 205, 9, 163, 132, 225, 194, 132, 136, 91, 197, 99, 109, 209, 105, 43, 220, 10, 54, 161, 207, 119, 87, 181, 187, 38, 40, 30, 225, 250, 182, 57, 167, 159, 48, 70, 123, 8, 163, 134, 222, 125, 229, 232, 57, 253, 97, 178, 116, 190, 30, 41, 232, 3, 223, 93, 3, 220, 56, 121, 255, 95, 55, 163, 22, 117, 4, 152, 45, 138, 209, 230, 142, 22, 60, 231, 230, 51, 42, 187, 200, 228, 103, 109, 67, 140, 120, 76, 152, 192, 28, 40, 58, 50, 43, 183, 205, 218, 217, 192, 44, 96, 89, 189, 115, 254, 232, 76, 171, 160, 252, 101, 22, 47, 211, 240, 36, 194, 128, 80, 201, 68, 17, 182, 44, 172, 235, 143, 99, 196, 150, 129, 152, 89, 48, 194, 84, 69, 52, 216, 5, 163, 153, 94, 148, 75, 253, 87, 73, 2, 22, 19, 49, 7, 53, 122, 178, 134, 28, 137, 64, 111, 40, 12, 6, 47, 179, 138, 196, 14, 226, 232, 18, 28, 177, 174, 250, 102, 250, 155, 22, 221, 86, 87, 85, 137, 119, 186, 182, 147, 118, 144, 219, 132, 211, 225, 29, 229, 110, 93, 178, 4, 13, 97, 124, 33, 19, 6, 41, 210, 186, 61, 185, 72, 39, 148, 98, 14, 137, 81, 185, 109, 221, 207, 120, 2, 167, 52, 28, 65, 71, 236, 39, 236, 116, 83, 81, 43, 80, 92, 92, 82, 8, 139, 34, 99, 222, 251, 174, 186, 49, 220, 215, 201, 31, 242, 231, 210, 92, 85, 65, 228, 44, 40, 114, 171, 140, 234, 67, 80, 193, 24, 231, 19, 220, 165, 20, 181, 80, 23, 254, 218, 241, 180, 201, 19, 100, 95, 193, 144, 30, 102, 38, 11, 49, 91, 55, 130, 226, 154, 218, 13, 211, 192, 249, 156, 75, 35, 169, 221, 202, 203, 160, 24, 227, 119, 66, 250, 244, 29, 220, 44, 43, 117, 94, 62, 79, 126, 22, 126, 253, 151, 104, 130, 1, 186, 86, 156, 91, 197, 29, 118, 117, 165, 168, 10, 87, 45, 114, 18, 161, 82, 52, 69, 111, 110, 189, 250, 253, 237, 178, 74, 187, 24, 17, 218, 108, 152};
static const size_t ints1_size = sizeof(ints1) / sizeof(unsigned);
static const unsigned ints2[] = {176, 254, 168, 45, 107, 190, 177, 70, 247, 24, 69, 77, 46, 54, 179, 241, 97, 108, 255, 21, 82, 142, 7, 81, 45, 166, 8, 135, 195, 42, 108, 215, 54, 6, 243, 247, 159, 66, 70, 26, 148, 127, 42, 221, 249, 167, 255, 236, 94, 246, 104, 16, 22, 100, 143, 225, 199, 68, 219, 46, 224, 89, 53, 62, 73, 67, 30, 116, 215, 91, 116, 158, 187, 78, 143, 42, 69, 242, 240, 28, 194, 179, 242, 40, 169, 30, 247, 193, 36, 30, 192, 8, 73, 152, 16, 124, 110, 202, 216, 156, 0, 210, 75, 225, 144, 174, 18, 52, 16, 38, 199, 74, 91, 170, 247, 247, 145, 77, 136, 128, 59, 107, 152, 20, 227, 214, 10, 98, 100, 193, 17, 240, 48, 211, 29, 142, 118, 99, 191, 47, 163, 65, 84, 134, 157, 48, 80, 78, 199, 248, 139, 90, 76, 61, 212, 187, 223, 168, 10, 154, 1, 147, 162, 71, 163, 207, 185, 60, 36, 29, 166, 188, 8, 223, 31, 18, 2, 165, 219, 229, 7, 224, 126, 100, 217, 91, 206, 175, 110, 247, 146, 71, 36, 200, 247, 228, 254, 30, 130, 132, 137, 236, 7, 219, 247, 153, 179, 31, 50, 191, 21, 172, 67, 87, 130, 234, 63, 15, 70, 26, 123, 146, 133, 219, 223, 4, 196, 91, 36, 222, 248, 209, 203, 48, 25, 203, 60, 65, 48, 204, 62, 46, 241, 148, 163, 207, 1, 41, 158, 191, 200, 18, 19, 110, 178, 73, 57, 193, 222, 184, 255, 56, 189, 243, 9, 3, 213, 245, 39, 23, 222, 102, 129, 190, 35, 170, 182, 99, 244, 255, 226, 185, 255, 208, 173, 150, 123, 156, 98, 41, 161, 221, 162, 182, 140, 170, 223, 157, 109, 202, 203, 82, 252, 126, 210, 243, 34, 27, 166, 66, 56, 32, 154, 111, 239, 2, 52, 16, 63, 152, 105, 137, 41, 134, 174, 97, 98, 39, 184, 99, 179, 231, 235, 213, 84, 59, 10, 26, 224, 176, 131, 95, 221, 146, 175, 117, 215, 144, 4, 139, 160, 45, 167, 39, 100, 18, 235, 212, 47, 74, 14, 0, 2, 237, 7, 166, 38, 53, 53, 234, 194, 24, 103, 184, 4, 127, 16, 107, 186, 76, 217, 184, 29, 113, 178, 231, 181, 231, 246, 166, 137, 213, 247, 42, 110, 219, 68, 140, 17, 123, 9, 165, 221, 80, 185, 62, 110, 63, 144, 28, 235, 215, 189, 238, 106, 165, 242, 170, 15, 204, 242, 12, 135, 250, 59, 249, 13, 243, 226, 220, 117, 111, 244, 103, 9, 68, 87, 73, 128, 156, 157, 61, 68, 252, 51, 54, 74, 71, 179, 120, 136, 98, 115, 136, 126, 27, 14, 34, 236, 110, 116, 38, 157, 196, 206, 41, 54, 228, 33, 111, 128, 29, 170, 112, 96, 236, 216, 11, 95, 203, 175, 239, 175, 239, 99, 233, 224, 199, 13, 48, 39, 103, 149, 82, 157, 181, 28, 89, 232, 199, 230, 20, 47, 6, 83, 95, 102, 82, 226, 73, 131, 72, 17, 61, 36, 63, 192, 92, 27, 48, 73, 48, 201, 186, 121, 210, 191, 34, 154, 173, 222, 37, 45, 46, 237, 62, 77, 246, 73, 120, 17, 230, 8, 13, 72, 37, 191, 28, 116, 6, 68, 215, 70, 208, 33, 50, 124, 26, 12, 13, 157, 232, 165, 103, 181, 196, 3, 187, 124, 78, 182, 219, 169, 108, 150, 192, 126, 110, 74, 38, 20, 102, 89, 129, 64, 94, 121, 40, 167, 83, 109, 158, 239, 31, 140, 211, 141, 73, 58, 163, 241, 89, 197, 156, 15, 118, 113, 71, 120, 48, 114, 198, 192, 211, 21, 148, 149, 213, 202, 29, 87, 231, 4, 20, 3, 177, 193, 121, 20, 64, 121, 2, 62, 44, 54, 222, 14, 33, 195, 161, 182, 31, 161, 27, 211, 5, 41, 12, 90, 143, 82, 250, 13, 1, 65, 55, 150, 179, 5, 162, 222, 116, 76, 168, 120, 203, 15, 88, 75, 131, 114, 129, 8, 44, 249, 184, 28, 203, 131, 14, 107, 173, 228, 63, 118, 57, 210, 127, 127, 230, 229, 89, 54, 119, 63, 84, 111, 81, 12, 157, 44, 106, 42, 192, 4, 161, 170, 126, 152, 225, 233, 12, 201, 113, 239, 214, 18, 230, 130, 48, 179, 149, 222, 34, 12, 86, 43, 182, 149, 159, 61, 85, 111, 127, 119, 217, 206, 197, 170, 45, 1, 210, 110, 243, 34, 55, 53, 15, 154, 23, 82, 130, 169, 98, 184, 209, 104, 238, 85, 50, 85, 243, 13, 62, 106, 72, 149, 148, 115, 132, 146, 247, 33, 46, 197, 193, 237, 78, 5, 219, 194, 43, 15, 154, 135, 135, 56, 8, 58, 44, 183, 66, 181, 201, 194, 227, 168, 95, 195, 143, 208, 41, 48, 149, 229, 7, 126, 197, 202, 181, 76, 46, 119, 250, 119, 176, 7, 71, 222, 105, 183, 98, 32, 231, 136, 129, 167, 112, 88, 205, 26, 170, 95, 200, 50, 28, 11, 38, 24, 254, 49, 91, 18, 172, 142, 144, 220, 200, 197, 119, 95, 128, 43, 95, 170, 202, 156, 147, 11, 170, 199, 160, 114, 129, 42, 255, 49, 121, 112, 98, 159, 142, 4, 246, 54, 117, 18, 129, 15, 208, 77, 47, 235, 50, 225, 181, 16, 78, 248, 189, 204, 80, 116, 46, 138, 43, 181, 195, 180, 11, 124, 45, 136, 156, 197, 100, 132, 45, 115, 69, 16, 5, 120, 112, 160, 167, 207, 162, 1, 82, 139, 240, 243, 27, 47, 205, 119, 196, 21, 101, 108, 176, 12, 80, 27, 67, 116, 64, 83, 154, 59, 71, 125, 43, 237, 161, 47, 37, 55, 180, 189, 228, 207, 21, 46, 111, 87, 187, 202, 138, 37, 225, 223, 83, 151, 77, 174, 146, 240, 144, 47, 121, 118, 146, 44, 66, 202, 163, 20, 70, 190, 218, 43, 15, 108, 136, 147, 116, 228, 158, 180, 228, 131, 144, 91, 242, 125, 162, 112, 120, 25, 152, 85, 45, 180, 62, 41, 76, 182, 110, 68, 82, 92, 197, 199, 198, 15, 106, 127, 69, 203, 233, 56, 81};
static const size_t ints2_size = sizeof(ints2) / sizeof(unsigned);

typedef struct {
  const unsigned long result;
  const char * const ident;
} print_result_args_t;

void print_result(const print_result_args_t * const args)
{
  printf("Result for '%s': %lu\n", args->ident, args->result);
}

int main()
{
  thread_sum_args_t sum_args0 = {ints1, ints1_size, 0},
                    sum_args1 = {ints2, ints2_size, 0},
                    sum_args2 = {ints2, ints2_size, 0},
                    sum_args3 = {ints1, ints1_size, 0};

  PAR_FUNCS(
    PFUNC(thread_sum, &sum_args0),
    PFUNC(thread_sum, &sum_args1),
    PFUNC(thread_sum, &sum_args2),
    PFUNC(thread_sum, &sum_args3));

  print_result_args_t print_args0 = {sum_args0.result, "job 0"},
                      print_args1 = {sum_args1.result, "job 1"},
                      print_args2 = {sum_args2.result, "job 2"},
                      print_args3 = {sum_args3.result, "job 3"};

  PAR_FUNCS(
    PFUNC(print_result, &print_args0),
    PFUNC(print_result, &print_args1),
    PFUNC(print_result, &print_args2),
    PFUNC(print_result, &print_args3));

  int ssize;
  asm("ldc %[ssize],thread_sum.nstackwords" : [ssize] "=r" (ssize));
  printf("thread_sum.nstackwords: %d\n", ssize);
  asm("ldc %[ssize],print_result.nstackwords" : [ssize] "=r" (ssize));
  printf("print_sum.nstackwords: %d\n", ssize);
  asm("ldc %[ssize],main.nstackwords" : [ssize] "=r" (ssize));
  printf("main.nstackwords: %d\n", ssize);
}


